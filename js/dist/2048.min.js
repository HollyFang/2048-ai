/* 2048 by luobotang
   tangkangxing@sina.com
*/
var Game=function(a){function b(){l=new Numbers,g(),h(),g(),h(),g(),m||(a("body").on("keydown",e),m=!0)}function c(){l.canMerge()||d()}function d(){a("#message").html("Game Over!").show(),a(document).unbind("keydown",e),m=!1}function e(a){switch(a.preventDefault(),a.keyCode){case 37:l.moveLeft(),f();break;case 38:l.moveUp(),f();break;case 39:l.moveRight(),f();break;case 40:l.moveDown(),f()}}function f(){g(),h(),g(),c()}function g(){l.forEach(function(b,c,d){var e=0===b?"":b,f="cell num-"+(0===b?"no":b>2048?"super":b);a("#cell-"+c+"-"+d).html(e).removeClass().addClass(f)})}function h(){console.log("Add random number");var a=j(i());l.set(a.row,a.col,k())}function i(){var b=a("#board .num-no").toArray(),c=b.length,e=Math.floor(Math.random()*c);return 0===c&&d(),b[e]}function j(b){var c=a(b);return{row:parseInt(c.data("row"),10),col:parseInt(c.data("col"),10)}}function k(){return Math.random()<.5?2:4}var l,m=!1;return{newRound:b}}(jQuery),Numbers=function(){this.numbers=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],this.rowCount=4,this.colCount=4};Numbers.prototype={forEach:function(a){a&&a.call&&this.numbers.forEach(function(b,c){b.forEach(function(b,d){a(b,c,d)})})},forEachRow:function(a){$.isFunction(a)&&this.numbers.forEach(function(b,c){a(b,c)})},forEachCol:function(a){if($.isFunction(a))for(var b=0;b<this.colCount;b++){for(var c=[],d=0;d<this.rowCount;d++)c.push(this.numbers[d][b]);a(c,b)}},get:function(a,b){var c=this.numbers[a];return c?c[b]:null},set:function(a,b,c){var d=this.numbers[a];d&&"number"==typeof d[a]&&(d[b]=c)},hasZero:function(){try{this.forEach(function(a){if(0===a)throw new Error("found")})}catch(a){return!0}return!1},moveLeft:function(){var a=this;this.forEachRow(function(b,c){a.mergeRow(b,c)}),console.log("Move Left")},moveUp:function(){var a=this;this.forEachCol(function(b,c){a.mergeCol(b,c)}),console.log("Move Up")},moveRight:function(){var a=this;this.forEachRow(function(b,c){a.mergeRow(b,c,!1)}),console.log("Move Right")},moveDown:function(){var a=this;this.forEachCol(function(b,c){a.mergeCol(b,c,!1)}),console.log("Move Down")},canMerge:function(){var a=this;try{this.forEachRow(function(b,c){if(a.canMergeArray(b))throw new Error("can merge row: "+c)}),this.forEachCol(function(b,c){if(a.canMergeArray(b))throw new Error("can merge col: "+c)})}catch(b){return!0}return!1},canMergeArray:function(a){for(var b=a.length,c=0,d=c+1;b>d;){var e=a[c],f=a[d];if(0===e||0===f)return!0;if(e===f)return!0;c=d,d=c+1}return!1},mergeRow:function(a,b,c){this.mergeArray(a,b,!0,c)},mergeCol:function(a,b,c){this.mergeArray(a,b,!1,c)},mergeArray:function(a,b,c,d){console.log("merge array: ",a.join()," index: ",b),d=null==d?!0:d;for(var e=a.length,f=d?0:e-1,g=d?f+1:f-1;d?e>g:g>=0;){var h=c?b:f,i=c?f:b,j=c?b:g,k=c?g:b,l=this.numbers[h][i],m=this.numbers[j][k];0!==m?0!==l?(m===l&&(this.numbers[h][i]=l+l,this.numbers[j][k]=0),f=d?f+1:f-1,g=d?f+1:f-1):(this.numbers[h][i]=m,this.numbers[j][k]=0,g=d?f+1:f-1):g=d?g+1:g-1}}};